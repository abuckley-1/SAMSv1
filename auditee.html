<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditee Portal | SAMS</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="background: #eef2f5;">
    <div class="form-card">
        <header style="border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
            <h1 id="form-title">Audit Questionnaire</h1>
            <p id="expiry-notice" style="color: #d63031; font-weight: bold;"></p>
        </header>

        <div id="questions-area"></div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
            <p style="font-size: 0.8rem; color: #666;">Progress saves automatically as you type.</p>
            <button onclick="finalSubmit()" class="btn primary-btn" style="width: 100%;">Final Submission to Audit Team</button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        const type = params.get('type');
        let audits = JSON.parse(localStorage.getItem('supertram_audit_data')) || [];
        let audit = audits.find(a => a.ref === ref);

        if (!audit || !audit.workflow[type]) {
            document.body.innerHTML = "<h1>Link Invalid or Not Yet Issued.</h1>";
        } else {
            checkExpiry();
            loadQuestions();
        }

        function checkExpiry() {
            const expiry = new Date(audit.workflow[type].expiryDate);
            if (new Date() > expiry) {
                document.getElementById('form-container').innerHTML = "<h2>This link expired after the 2-week window.</h2>";
            } else {
                document.getElementById('expiry-notice').innerText = "Valid until: " + expiry.toLocaleDateString();
            }
        }

        function loadQuestions() {
            const area = document.getElementById('questions-area');
            // Initial is fixed, Followup is bespoke (Sample logic here)
            const questions = type === 'initial' ? ["What is the process?", "Identify risks"] : ["Follow-up Item 1", "Evidence Check"];
            
            area.innerHTML = questions.map((q, i) => `
                <div class="q-box" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">${i+1}. ${q}</label>
                    <textarea oninput="autoSave(${i}, this.value)" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd;">${audit.workflow[type].responses[i] || ''}</textarea>
                    ${type === 'followup' ? `<div style="margin-top:10px;"><input type="file" multiple> <small>(Max 3 files)</small></div>` : ''}
                </div>
            `).join('');
        }

        function autoSave(index, val) {
            audit.workflow[type].responses[index] = val;
            localStorage.setItem('supertram_audit_data', JSON.stringify(audits));
        }

        function finalSubmit() {
            if(confirm("Submit final report? You won't be able to edit after this.")) {
                audit.workflow[type].status = 'Completed';
                localStorage.setItem('supertram_audit_data', JSON.stringify(audits));
                alert("Audit Team Alerted: healthandsafety@supertram.com");
                window.location.href = "index.html";
            }
        }
    </script>
</body>
</html>
