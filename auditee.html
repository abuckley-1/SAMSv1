<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auditee Portal | SAMS</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="background: #f0f2f5;">
    <div class="form-card" style="max-width: 900px; margin: 40px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <header style="border-bottom: 3px solid #ffcc00; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 id="audit-title" style="margin:0; color: #004c94;">---</h1>
            <p style="margin:5px 0; color:#666;">Reference: <span id="audit-ref" style="font-weight:bold;">---</span></p>
            <p id="expiry-notice" style="color:#d63031; font-weight:bold; margin-top: 10px;"></p>
        </header>

        <div id="form-content">
            <section class="q-section">
                <h3 style="color: #004c94; border-left: 5px solid #004c94; padding-left: 10px;">1. Auditee Details</h3>
                <div class="q-box">
                    <label>Auditee Full Name</label>
                    <input type="text" id="auditee-name" oninput="saveResp('auditeeName', this.value)" placeholder="Enter your name">
                </div>
                <div class="q-box">
                    <label>Date Started</label>
                    <input type="date" id="date-started" oninput="saveResp('startDate', this.value)">
                </div>
            </section>

            <section class="q-section">
                <h3 style="color: #004c94; border-left: 5px solid #004c94; padding-left: 10px;">2. Core Compliance</h3>
                <div class="q-box">
                    <label>Is there a policy and or procedure for the referenced process?</label>
                    <textarea oninput="saveResp('q_policy', this.value)" id="q_policy"></textarea>
                </div>
                <div class="q-box">
                    <label>Is there a risk assessment for the referenced process?</label>
                    <textarea oninput="saveResp('q_risk', this.value)" id="q_risk"></textarea>
                </div>
                <div class="q-box">
                    <label>Do you feel all relevant persons have received suitable and sufficient information, instruction and training for the referenced process?</label>
                    <textarea oninput="saveResp('q_training', this.value)" id="q_training"></textarea>
                </div>
            </section>

            <section class="q-section">
                <h3 style="color: #004c94; border-left: 5px solid #004c94; padding-left: 10px;">3. Standards Verification (ISO & RM3)</h3>
                <div id="ai-questions-container"></div>
            </section>

            <section class="q-section">
                <h3 style="color: #004c94; border-left: 5px solid #004c94; padding-left: 10px;">4. Closing</h3>
                <div class="q-box">
                    <label>General and or Further comments from Auditee?</label>
                    <textarea oninput="saveResp('q_general', this.value)" id="q_general" style="height:150px;"></textarea>
                </div>
            </section>

            <button onclick="finalSubmit()" class="btn primary-btn" style="width:100%; padding:20px; font-size:1.2rem; cursor: pointer;">FINAL SUBMISSION</button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        let audits = JSON.parse(localStorage.getItem('supertram_audit_data')) || [];
        let audit = audits.find(a => a.ref === ref);

        window.onload = () => {
            if (!audit || !audit.workflow || !audit.workflow.initial) {
                document.getElementById('form-content').innerHTML = "<h2>Audit Link Invalid or Not Issued.</h2>";
                return;
            }

            const workflow = audit.workflow.initial;
            const expiry = new Date(workflow.expiryDate);
            
            if (new Date() > expiry) {
                document.getElementById('form-content').innerHTML = "<h2>This link expired on " + expiry.toLocaleDateString() + ".</h2>";
                return;
            }

            document.getElementById('audit-title').innerText = audit.title + " - Initial Questionnaire";
            document.getElementById('audit-ref').innerText = audit.ref;
            document.getElementById('expiry-notice').innerText = "Link Valid Until: " + expiry.toLocaleDateString();
            
            // Populate responses
            document.getElementById('auditee-name').value = workflow.responses.auditeeName || '';
            document.getElementById('date-started').value = workflow.responses.startDate || '';
            document.getElementById('q_policy').value = workflow.responses.q_policy || '';
            document.getElementById('q_risk').value = workflow.responses.q_risk || '';
            document.getElementById('q_training').value = workflow.responses.q_training || '';
            document.getElementById('q_general').value = workflow.responses.q_general || '';

            const container = document.getElementById('ai-questions-container');
            container.innerHTML = workflow.aiQuestions.map((q, i) => `
                <div class="q-box" style="margin-bottom: 25px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <label style="color:#004c94; font-size:0.75rem; text-transform: uppercase;">Standard: ${q.standard}</label>
                    <label style="display:block; margin-bottom:10px; font-weight: bold;">${i+1}. ${q.text}</label>
                    <textarea oninput="saveResp('ai_${i}', this.value)" style="width: 100%; padding: 10px; border: 1px solid #ccc;">${workflow.responses['ai_'+i] || ''}</textarea>
                </div>
            `).join('');
        };

        function saveResp(key, val) {
            audit.workflow.initial.responses[key] = val;
            localStorage.setItem('supertram_audit_data', JSON.stringify(audits));
        }

        function finalSubmit() {
            if(confirm("Confirm Final Submission to healthandsafety@supertram.com?")) {
                audit.status = "CLOSED";
                localStorage.setItem('supertram_audit_data', JSON.stringify(audits));
                alert("Audit Submitted Successfully.");
                window.location.href = "index.html";
            }
        }
    </script>
</body>
</html>
